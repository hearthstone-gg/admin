<!doctype html>
<html lang="en">
  <head>
    <title>Hearthstone.gg - Admin</title>
    <script src="https://code.jquery.com/jquery-git2.min.js"></script>
     
    <link rel="stylesheet" href="bower_components/ng-admin/build/ng-admin.min.css">
  </head>
  <body ng-app="myApp">
    <div ui-view></div>
    <script src="bower_components/ng-admin/build/ng-admin.min.js"></script>
    <script type="text/javascript">
    window.__hsggServices = JSON.parse($.ajax({
        type: 'GET',
        url: '/services.json',
        async: false
    }).responseText); 

    var myApp = angular.module('myApp', ['ng-admin']);
    myApp.config(['NgAdminConfigurationProvider', 'RestangularProvider', function(NgAdminConfigurationProvider, RestangularProvider) {
            
            var nga = NgAdminConfigurationProvider;
            // create an admin application
            var admin = nga.application('hs.gg Admin');
            admin.baseApiUrl('http://' + window.__hsggServices.api.domain+'/');

            // entity factory function
            var user = nga.entity('user').identifier(nga.field('_id')).label('Users');
            
            var game = nga.entity('game').identifier(nga.field('_id')).label('Games');
        
             user.creationView().fields([
                nga.field('bnet.name').label('BNET name'),
                nga.field('bnet.id').label('BNET id'), 
            ]);

            user.listView()
                .title('Users').fields([
                    user.creationView().fields(), // reuse fields from another view in another order
                    nga.field('_id').label('id').editable(false),
                    nga.field('updated', 'date').label('updated').format('MM/dd HH:mm').editable(false),
                    nga.field('created', 'date').label('created').format('MM/dd HH:mm').editable(false),
                ])
                .listActions(['show', 'edit', 'delete']);

            user.editionView().fields([
                user.listView().fields(), // reuse fields from another view in another order
                nga.field('bnet.token').label('BNET token'),
                nga.field('token').label('token'),
            ]).title('Edit {{ entry.values["bnet.name"] }}');

            user.showView().fields([
                user.listView().fields(), // reuse fields from another view in another order
                nga.field('token').label('token').editable(false),
                nga.field('bnet.token').label('BNET token').editable(false)
            ]);

           
            admin.addEntity(user);



            //game

            
            var reporterId = nga.field('reporterId', 'reference').label('Player ID')
                    .targetEntity(admin.getEntity('user')) // Select a target Entity
                    .targetField(nga.field('_id'));

             game.creationView().fields([
                reporterId,
                    
                nga.field('status', 'choice').label('Status').choices([
                  { value: 'WIN', label: 'Win' },
                  { value: 'LOSS', label: 'Loss' },
                  { value: 'TIE', label: 'Tie' },
                ]),
                nga.field('name').label('reporter'),
                nga.field('opponentName').label('opponent'),
            ]);

            game.listView()
                .title('Games').fields([
                    game.creationView().fields(), // reuse fields from another view in another order
                    nga.field('_id').label('id').editable(false),
                    nga.field('updated', 'date').label('updated').format('MM/dd HH:mm').editable(false),
                    nga.field('created', 'date').label('created').format('MM/dd HH:mm').editable(false),
                ])
                .listActions(['show', 'edit', 'delete'])
                .perPage(25);

            game.editionView().fields([
                game.listView().fields(), // reuse fields from another view in another order
            ]).title('Edit {{ entry.values["_id"] }}');

            game.showView().fields([
                game.listView().fields(), // reuse fields from another view in another order
            ]);

           
            admin.addEntity(game);

            // menu factory function
            var menu = nga.menu();
            menu.addChild(nga.menu(user).icon('<span class="glyphicon glyphicon-user"></span>'));
            menu.addChild(nga.menu(game).icon('<span class="glyphicon glyphicon-tower"></span>'));
            admin.menu(menu);

            // dashboard factory function
            var dashboard = nga.dashboard();


            RestangularProvider.addFullRequestInterceptor(function(element, operation, what, url, headers, params, httpConfig) {
                console.log('adding', arguments)
                if (operation == 'getList') {
                    params.skip = (params._page - 1) * params._perPage
                    params.limit = params._perPage

                    delete params._page;
                    delete params._perPage;
                }
                return { params: params };
            });

            // more configuation here later
            // ...
            // attach the admin application to the DOM and run it
            nga.configure(admin);    
    }]);
    </script>
  </body>
</html>